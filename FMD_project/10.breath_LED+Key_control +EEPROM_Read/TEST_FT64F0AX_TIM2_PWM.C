// Project: TEST_64F0Ax_TIM2_PWM.prj
// Device:  FT64F0AX
// Memory:  PROM=10Kx14, SRAM=1KB, EEPROM=128
// Description: 
//1.ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È£
//          Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?

//2.ï¿½ï¿½ï¿½ï¿½ï¿½É¿ï¿½Ö®ï¿½ï¿½Ò»ï¿½ï¿½ï¿½Ó£ï¿½ï¿½ï¿½ï¿½æµ±Ç°ï¿½ï¿½ï¿½Èµï¿½ eepromï¿½ï¿½ï¿½Â´ï¿½ï¿½Ïµï¿½ï¿½Ê±ï¿½ï¿½ï¿½ eeprom ï¿½ï¿½È¡ï¿½ï¿½Ó¦ï¿½ï¿½ï¿½ï¿½
//
// RELEASE HISTORY
// VERSION DATE     DESCRIPTION
// 1.6        25-6-5        ï¿½Þ¸ï¿½ÏµÍ³Ê±ï¿½ï¿½Îª8MHzï¿½ï¿½Ê¹ï¿½ï¿½LVR
//                FT64F0A5  TSSOP20
//             -------------------
// TIM2_CH1----|1(PA5)   	(PA4)20|-----TIM2_CH2
// NC----------|2(PA6)   	(PA3)19|-----------NC
// NC----------|3(PA7)   	(PA2)18|-----------NC
// NC----------|4(PC0)   	(PA1)17|-----------NC
// NC----------|5(PC1)		(PA0)16|-----------NC
// NC----------|6(PB7)		(PB0)15|-----------NC
// GND---------|7(GND)		(PB1)14|-----------NC
// NC----------|8(PB6)		(PB2)13|-----------NC
// VDD---------|9(VDD)		(PB3)12|-----------NC
// NC----------|10(PB5)		(PB4)11|-----------NC
//				-------------------
//
//*********************************************************
#include "SYSCFG.h"
#include "FT64F0AX.h"

#include "delay.h"

// *********************** åŽŸæœ‰å®å®šä¹‰ ****************************
#define DemoPortOut PB3
#define T2_CH1_PIN PA5 // TIM2_CH1å¯¹åº”PA5ï¼ˆLEDå¼•è„šï¼‰
// *********************** æ–°å¢žæŒ‰é”®å®å®šä¹‰ ****************************
#define KEY_PIN PA0            // æŒ‰é”®å¼•è„šï¼ˆPA0ï¼‰
#define KEY0_PRESSED 0B1000010 // æŒ‰é”®æŒ‰ä¸‹ç”µå¹³ï¼ˆä¸Šæ‹‰è¾“å…¥ï¼ŒæŒ‰ä¸‹ä¸ºä½Žï¼‰
#define KEY1_PRESSED 0B1000001 // æŒ‰é”®æŒ‰ä¸‹ç”µå¹³ï¼ˆä¸Šæ‹‰è¾“å…¥ï¼ŒæŒ‰ä¸‹ä¸ºä½Žï¼‰
#define KEY_RELEASED 0B1000011 // æŒ‰é”®é‡Šæ”¾ç”µå¹³
#define DEBOUNCE_MS 20         // æŒ‰é”®æ¶ˆæŠ–æ—¶é—´ï¼ˆ20msï¼‰

#define KEY1_PIN PA1 // æŒ‰é”®å¼•è„šï¼ˆPA1ï¼‰

// *********************** åŽŸæœ‰å˜é‡å®šä¹‰ ****************************
volatile char W_TMP @0x70;   // ç³»ç»Ÿå ç”¨ï¼Œä¸å¯åˆ é™¤
volatile char BSR_TMP @0x71; // ç³»ç»Ÿå ç”¨ï¼Œä¸å¯åˆ é™¤
unsigned char TempH1;
unsigned char TempL1;
unsigned int ComValue1; // TIM2_CH1æ¯”è¾ƒå€¼ï¼ˆæŽ§åˆ¶å ç©ºæ¯”ï¼‰
unsigned int T1;        // å‘¼å¸å‘¨æœŸå‚æ•°
// unsigned char TempH2;
// unsigned char TempL2;
// unsigned int ComValue2;
unsigned int T2;
unsigned char Compare_Flag;
volatile unsigned char TIM1_Count = 0; // TIM1ä¸­æ–­è®¡æ•°ï¼ˆ1ms/æ¬¡ï¼Œvolatileç¡®ä¿å®žæ—¶æ›´æ–°ï¼‰
unsigned char breath_Flag1 = 0;        // å‘¼å¸æ–¹å‘æ ‡å¿—ï¼ˆ0=å˜æš—ï¼Œ1=å˜äº®ï¼‰

// *********************** æ–°å¢žæ¨¡å¼ä¸ŽæŒ‰é”®å˜é‡ ****************************
unsigned char breath_mode = 1; // å‘¼å¸æ¨¡å¼ï¼š1=å‘¼å¸ï¼Œ0=æš‚åœ
// æŒ‰é”®æ¶ˆæŠ–é™æ€å˜é‡ï¼ˆéžé˜»å¡žç”¨ï¼‰
static unsigned char key_last_level = KEY_RELEASED; // ä¸Šæ¬¡æŒ‰é”®ç”µå¹³
static unsigned int key_debounce_tick = 0;          // æŒ‰é”®æ¶ˆæŠ–æ—¶é—´æˆ³ï¼ˆåŸºäºŽTIM1_Countï¼‰
// *********************** æ–°å¢žä¸²å£+EEPROMå˜é‡ ****************************
unsigned char EEPROM_Start = 0;
unsigned int EEPROM_Write_count = 0; // æ–°å¢žEEPROMxå†™å…¥è®¡æ—¶æ ‡å¿—
unsigned int EEPROM_Write_Flag1 = 0; // æ–°å¢žEEPROMå¯ä»¥å†™å…¥æ ‡å¿—
// volatile unsigned char receivedata = 0;
// volatile unsigned char sendaddress = 0;
// volatile unsigned char senddata = 0;
// volatile unsigned char EEReadData = 0xAA;
// unsigned char send_flag = 0;
// unsigned char init_send_done = 0;

// å‡½æ•°å£°æ˜Ž
void user_isr(); 
void POWER_INITIAL(void);
void TIM2_INITIAL(void);
void TIM1_INITIAL(void);
unsigned char Key_Scan_NonBlock(void);


//===========================================================
// Funtion nameï¿½ï¿½interrupt ISR
// parametersï¿½ï¿½ï¿½ï¿½
// returned valueï¿½ï¿½ï¿½ï¿½
//===========================================================
void interrupt ISR(void)
{
#asm;			// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	NOP;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
#endasm;		// ÏµÍ³ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½É¾ï¿½ï¿½ï¿½ï¿½ï¿½Þ¸ï¿½
	user_isr(); // ï¿½ï¿½ï¿½ï¿½ï¿½Ã»ï¿½ï¿½Ð¶Ïºï¿½ï¿½ï¿½
}
void user_isr() // ï¿½ï¿½ï¿½ï¿½ï¿½Ã»ï¿½ï¿½Ð¶Ïºï¿½ï¿½ï¿½
{
	T1UIF = 1;		// Ð´1ï¿½ï¿½ï¿½ï¿½ï¿½Ö¾ï¿½?
	PORTB = ~PORTB; // ï¿½ï¿½×ªï¿½ï¿½Æ½
	TIM1_Count++;
}
/*-------------------------------------------------
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½POWER_INITIAL
 * ï¿½ï¿½ï¿½Ü£ï¿½  ï¿½Ïµï¿½ÏµÍ³ï¿½ï¿½Ê¼ï¿½ï¿½
 * ï¿½ï¿½ï¿½ë£º  ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½ï¿½?  ï¿½ï¿½
 --------------------------------------------------*/
void POWER_INITIAL(void)
{
	OSCCON = 0B01100001; // ï¿½Ú²ï¿½16MHzÊ±ï¿½Ó£ï¿½ï¿½ï¿½Æµ1:1
	INTCON = 0;			 // ï¿½ï¿½Ö¹ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½

	// ********** Ô­ï¿½ï¿½GPIOï¿½ï¿½Ê¼ï¿½ï¿½ **********
	PORTA = 0B00000000;
	PORTB = 0B00000000;
	PORTC = 0B00000000;
	WPUA = 0B00000000; 
	WPUB = 0B00000000;
	WPUC = 0B00000000;
	WPDA = 0B00000000;
	WPDB = 0B00000000;
	WPDC = 0B00000000;
	TRISA = 0B00000000; 
	TRISB = 0B00000000;
	TRISC = 0B00000000;

	// ********** ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½PA0ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ë£© **********
	TRISA |= 0B00000001; 
	WPUA |= 0B00000001;   // ï¿½ï¿½ï¿½ï¿½PA0ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¹ï¿½ï¿½ï¿½ï¿½ï¿½ó´¥·ï¿½ï¿½ï¿½

	// ********** Ô­ï¿½Ðµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ **********
	PSRC0 = 0B11111111; // Ô´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?
	PSRC1 = 0B11111111;
	PSRC2 = 0B00001111;
	PSINK0 = 0B11111111; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	PSINK1 = 0B11111111;
	PSINK2 = 0B00000011;
	ANSELA = 0B00000000; // PA0ï¿½ï¿½Îªï¿½ï¿½ï¿½ï¿½IO
}
/**
 * ï¿½Þ¸ï¿½ï¿½ï¿½Ä·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?ï¿½è£¨PA0ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½Öµï¿½ï¿½1=ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ó£¬½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½Î£ï¿½ï¿½ï¿½0=ï¿½Þ°ï¿½ï¿½ï¿½/Î´ï¿½È¶ï¿½
 */


void TIM2_INITIAL(void)
{
	PCKEN |= 0B00000100; // Ê¹ï¿½ï¿½TIMER2Ä£ï¿½ï¿½Ê±ï¿½ï¿½
	CKOCON = 0B00100000; // Timer2ï¿½ï¿½ÆµÊ±ï¿½ï¿½Õ¼ï¿½Õ±Èµï¿½ï¿½ï¿½Î»4nsï¿½Ó³ï¿½
	TCKSRC = 0B00110000; // Timer2Ê±ï¿½ï¿½Ô´ÎªHIRCï¿½ï¿½2ï¿½ï¿½Æµ

	TIM2CR1 = 0B10000101; // ï¿½ï¿½ï¿½ï¿½ï¿½Ô¶ï¿½×°ï¿½Ø£ï¿½Ê¹ï¿½Ü¼ï¿½ï¿½ï¿½ï¿½ï¿½

	TIM2IER = 0B00000000; // ï¿½ï¿½Ö¹ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½

	TIM2SR1 = 0B00000000;
	TIM2SR2 = 0B00000000;

	TIM2EGR = 0B00000000;

	TIM2CCMR1 = 0B01101000; // ï¿½ï¿½Í¨ï¿½ï¿½CH1ï¿½ï¿½ï¿½ï¿½Îªï¿½ï¿½ï¿½ï¿½ï¿½PWMÄ£Ê½1
	TIM2CCMR2 = 0B01101000; // ï¿½ï¿½Í¨ï¿½ï¿½CH2ï¿½ï¿½ï¿½ï¿½Îªï¿½ï¿½ï¿½ï¿½ï¿½PWMÄ£Ê½1
	TIM2CCMR3 = 0B00000000;

	TIM2CCER1 = 0B00110011; // ï¿½È½ï¿½1ï¿½ï¿½2ï¿½ï¿½ï¿½Ê¹ï¿½Ü£ï¿½ï¿½Íµï¿½Æ½ï¿½ï¿½ï¿½?
	TIM2CCER2 = 0B00000000;

	TIM2CNTRH = 0B00000000;
	TIM2CNTRL = 0B00000000;

	TIM2ARRH = 0x03; // ï¿½Ô¶ï¿½×°ï¿½Ø¸ï¿½8Î»03H
	TIM2ARRL = 0xe8; // ï¿½Ô¶ï¿½×°ï¿½Øµï¿½8Î»e8H

	TIM2CCR1H = 0x01; // ×°ï¿½ï¿½È½ï¿½?1ï¿½ï¿½Ô¤×°ï¿½ï¿½Öµï¿½ï¿½8Î»01H
	TIM2CCR1L = 0xf4; // ×°ï¿½ï¿½È½ï¿½?1ï¿½ï¿½Ô¤×°ï¿½ï¿½Öµï¿½ï¿½8Î»F4H

	TIM2CCR2H = 0x01; // ×°ï¿½ï¿½È½ï¿½?2ï¿½ï¿½Ô¤×°ï¿½ï¿½Öµï¿½ï¿½8Î»01H
	TIM2CCR2L = 0xf4; // ×°ï¿½ï¿½È½ï¿½?2ï¿½ï¿½Ô¤×°ï¿½ï¿½Öµï¿½ï¿½8Î»F4H

	TIM2CCR3H = 0B00000000;
	TIM2CCR3L = 0B00000000;
}
/*-------------------------------------------------
* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½TIM1_INITIAL
* ï¿½ï¿½ï¿½Ü£ï¿½  ï¿½ï¿½Ê¼ï¿½ï¿½TIM1
* ï¿½ï¿½ï¿½ë£º  ï¿½ï¿½
* ï¿½ï¿½ï¿½ï¿½ï¿½?  ï¿½ï¿½
--------------------------------------------------*/
void TIM1_INITIAL(void)
{
	PCKEN |= 0B00000010;  // Ê¹ï¿½ï¿½TIMER1Ä£ï¿½ï¿½Ê±ï¿½ï¿½
	CKOCON = 0B00100000;  // Timer1ï¿½ï¿½ÆµÊ±ï¿½ï¿½Õ¼ï¿½Õ±Èµï¿½ï¿½ï¿½Î»4nsï¿½Ó³ï¿½
	TCKSRC |= 0B00000011; // Timer1Ê±ï¿½ï¿½Ô´ÎªHIRCï¿½ï¿½2ï¿½ï¿½Æµ

	TIM1CR1 = 0B10000101; // ï¿½ï¿½ï¿½ï¿½ï¿½Ô¶ï¿½×°ï¿½Ø£ï¿½Ê¹ï¿½Ü¼ï¿½ï¿½ï¿½ï¿½ï¿½

	TIM1IER = 0B00000001; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½

	TIM1ARRH = 0x7C; // ï¿½Ô¶ï¿½×°ï¿½Ø¸ï¿½8
	TIM1ARRL = 0xFF; // ï¿½Ô¶ï¿½×°ï¿½Øµï¿½8Î»  1ms ï¿½ï¿½Ò»ï¿½ï¿½ï¿½Ð¶ï¿½

	INTCON = 0B11000000; // Ê¹ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶Ïºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½
}
/*-------------------------------------------------
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½main
 * ï¿½ï¿½ï¿½Ü£ï¿½  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½ë£º  ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½ï¿½?  ï¿½ï¿½
 --------------------------------------------------*/
unsigned char Key_Scan_NonBlock(void) // PA0+PA1°´¼üÉ¨Ãè+Ïû¶¶
{
    static unsigned char key_state = 0;                    // 0=ÊÍ·Å£¬1=Ïû¶¶ÖÐ£¬2=°´ÏÂ
    unsigned char key_current_level = (PORTA & 0B1000011); // ¶ÁÈ¡PA0ºÍPA1µÄµçÆ½
    unsigned int ret_val = 0;                             // ·µ»ØÖµÏÈ¼ÇÂ¼£¬×îºóÍ³Ò»·µ»Ø
    switch (key_state)
    {
    case 0: // ÊÍ·Å×´Ì¬£¬¼ì²â°´ÏÂ
        if ((key_current_level == KEY0_PRESSED) || (key_current_level == KEY1_PRESSED))
        {
            key_debounce_tick = TIM1_Count; // ¼ÇÂ¼Ïû¶¶¿ªÊ¼Ê±¼ä
            key_state = 1;                  // ½øÈëÏû¶¶ÖÐ×´Ì¬
        }
        break;

    case 1: // Ïû¶¶ÖÐ£¬ÅÐ¶ÏÊÇ·ñÎÈ¶¨°´ÏÂ20ms
        // ´¦ÀíTIM1_CountÒç³ö£¨8Î»±äÁ¿£¬Òç³öºó²îÖµÎª¸º£¬Ðè×ª»»ÎªÎÞ·ûºÅ£©
        if ((unsigned char)(TIM1_Count - key_debounce_tick) >= DEBOUNCE_MS)
        {
            if (key_current_level == KEY0_PRESSED)
            {
                key_state = 2; // È·ÈÏ°´ÏÂ
                ret_val = KEY0_PRESSED;   // ·µ»Ø°´ÏÂÊÂ¼þ
            }
            else if (key_current_level == KEY1_PRESSED)
            {
                key_state = 2; // È·ÈÏ KEY1 °´ÏÂ£¬½øÈë case 2
                ret_val =KEY1_PRESSED;
            }
            else
            {
                key_state = 0;
                ret_val = 0;
            }
        }
        break;

    case 2: // °´ÏÂ×´Ì¬£¬¼ì²âÊÍ·Å
        if (key_current_level == KEY_RELEASED)
        {
            key_debounce_tick = TIM1_Count;
            key_state = 3; // ½øÈëÊÍ·ÅÏû¶¶
        }
        break;

    case 3: // ÊÍ·ÅÏû¶¶£¬ÎÈ¶¨ºó¸´Î»
        if ((unsigned char)(TIM1_Count - key_debounce_tick) >= DEBOUNCE_MS)
        {
            key_state = 0; // »Øµ½ÊÍ·Å×´Ì¬
        }
        break;
    }
    return ret_val;
}

/*-------------------------------------------------
* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½TIM2_INITIAL
* ï¿½ï¿½ï¿½Ü£ï¿½  ï¿½ï¿½Ê¼ï¿½ï¿½TIM2
* ï¿½ï¿½ï¿½ë£º  ï¿½ï¿½
* ï¿½ï¿½ï¿½ï¿½ï¿½?  ï¿½ï¿½
*/
void main(void)

{
    POWER_INITIAL(); 
    TIM2_INITIAL();  
    TIM1_INITIAL();  

    // ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    TempH1 = TIM2CCR1H;
    TempL1 = TIM2CCR1L;
    ComValue1 = TempH1 * 256 + TempL1;  
    T1 = 2 * (TempH1 * 256 + TempL1) - 1;
    Compare_Flag = 0;
    static unsigned int last_breath_tick = 0; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½?

        while (1)
    {
        // 1. ï¿½ï¿½ï¿½ï¿½É¨ï¿½è£ºï¿½Ð»ï¿½ï¿½ï¿½ï¿½ï¿½/ï¿½Â½ï¿½Ä£Ê½ï¿½ï¿½ï¿½ï¿½Æµï¿½ï¿½ï¿½Ã£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (Key_Scan_NonBlock() == KEY1_PRESSED)
        {
            breath_mode = 1; // PA1ï¿½ï¿½ï¿½Â£ï¿½Òªï¿½ï¿½ï¿½ï¿½
            breath_Flag1 = 1;
            EEPROM_Start = breath_Flag1;
        }
        if (Key_Scan_NonBlock() == KEY0_PRESSED)
        {
            breath_mode = 0; // PA0ï¿½ï¿½ï¿½Â£ï¿½Òªï¿½Â½ï¿½
            breath_Flag1 = 0;
            EEPROM_Start = breath_Flag1;
        }

        // 2. ï¿½ï¿½ï¿½ï¿½Ä£Ê½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?
        if (breath_mode == 1)
        {
            //            if (EEPROM_Write_count >= 1000) // EEPROMÐ´ï¿½ï¿½ï¿½Ú°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½1sï¿½ï¿½ï¿½ï¿½ï¿½?
            //            {
            //                EEPROM_Write_Flag1 = 0;
            //                EEPROM_Write_count = 0; // ï¿½ï¿½ï¿½ï¿½
            //                EEPROM_Start = 3;       // ï¿½ï¿½ï¿½ï¿½
            //                EEPROMwrite(0x13, ComValue1 / 256);
            //                EEPROMwrite(0x14, ComValue1 % 256);
            //            }
            if ((unsigned char)(TIM1_Count - last_breath_tick) > 49) // Ã¿50msï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½Õ¼ï¿½Õ±ï¿½
            {
                last_breath_tick = TIM1_Count; // ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½?

                if (breath_Flag1 == 1) // ï¿½ä°µï¿½ï¿½Ö¾
                {
                    if (ComValue1 <= T1)
                    {
                        ComValue1 += 20;
                    }
                    else
                    {
                        ComValue1 = T1;
                    }
                    TIM2CCR1H = ComValue1 / 256;
                    TIM2CCR1L = ComValue1 % 256;

                    // if (ComValue1 >= T1)
                    // {
                    //     breath_Flag1 = 0;
                    // }
                }
                // Êµï¿½ï¿½Ð´ï¿½ï¿½EEPROM
            }
        }
        if (breath_mode == 0)
        {
            //            if (EEPROM_Write_count >= 1000) // EEPROMÐ´ï¿½ï¿½ï¿½Ú°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½1sï¿½ï¿½ï¿½ï¿½ï¿½?
            //            {
            //                EEPROM_Write_Flag1 = 0;
            //                EEPROM_Write_count = 0; // ï¿½ï¿½ï¿½ï¿½
            //                EEPROM_Start = 3;       // ï¿½ï¿½ï¿½ï¿½
            //                EEPROMwrite(0x13, ComValue1 / 256);
            //                EEPROMwrite(0x14, ComValue1 % 256);
            //            }
            if ((unsigned char)(TIM1_Count - last_breath_tick) > 49) // Ã¿50msï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½Õ¼ï¿½Õ±ï¿½
            {

                last_breath_tick = TIM1_Count; // ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½?
                if (breath_Flag1 == 0)         // ï¿½ï¿½liangï¿½ï¿½Ö¾
                {
                    if (ComValue1 <= T1 && ComValue1 > 0)
                    {
                        ComValue1 -= 20;
                    }
                    else if (ComValue1 > T1)
                    {
                        ComValue1 = T1;
                    }
                    else if (ComValue1 <= 0) // Ô½ï¿½ï¿½ï¿½Ð¶ÏµÄ½ï¿½ï¿½Ë¼Â·ï¿½Ç£ï¿½Ô½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                    {
                        ComValue1 = 0;
                    }
                    TIM2CCR1H = ComValue1 / 256;
                    TIM2CCR1L = ComValue1 % 256;

                    // if (ComValue1 >= T1)
                    // {
                    //     breath_Flag1 = 1;
                    // }
                }
                // Êµï¿½ï¿½Ð´ï¿½ï¿½EEPROM
            }
        }

        NOP();
    }

}