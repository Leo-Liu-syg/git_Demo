// Project: TEST_FT64F0AX_iotrigger.prj
// Device:  FT64F0AX
// Memory:  PROM=10Kx14, SRAM=1KB, EEPROM=128
// Description: ADC_ETR�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7AN0�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7AD�0�5�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7�1�7�0�9
//
// RELEASE HISTORY
// VERSION DATE     DESCRIPTION
// 1.6        25-6-4        �1�7�1�0�1�7�0�3�0�1�0�2�1�7�1�7�0�28MHz�1�7�1�7�0�0�1�7�1�7LVR
//
//                FT64F0A5  TSSOP20
//              -------------------
// NC----------|1(PA5)   	(PA4)20|-----------ADC_ETR
// NC----------|2(PA6)   	(PA3)19|-----------NC
// NC----------|3(PA7)   	(PA2)18|-----------NC
// NC----------|4(PC0)   	(PA1)17|-----------NC
// NC----------|5(PC1)		(PA0)16|-----------NC
// NC----------|6(PB7)		(PB0)15|-----------NC
// GND---------|7(GND)		(PB1)14|----------AN0
// NC----------|8(PB6)		(PB2)13|-----------NC
// VDD---------|9(VDD)		(PB3)12|-----------NC
// NC----------|10(PB5)		(PB4)11|-----------NC
//				-------------------
//
//*********************************************************
#include "SYSCFG.h"
#include "FT64F0AX.h"
#include "TDelay.h" // �Ȱ�����ʱͷ�ļ����ٰ���������ʱ��IICͷ�ļ�
#include "TM1650_IIC.h"
#include "EEPROM.h"
#include "ADC.h"

//***********************宏定义****************************
#define uchar unsigned char
#define uint unsigned int
#define ulong unsigned long
#define TM1650_WRITE_ADDR 0x48
#define TM1650_CMD_DISP_ON 0x01 // 8�����ȣ�7����ʾ��������ʾʹ�ܣ��ֲ�����ˣ�
#define TM1650_CMD_ADDR_BASE 0x68
#define SCL PB3
#define SDA PB4

#define TM1650_SCL_HOLD_TIME 5 // ��λ��s����4��s��
#define TM1650_ACK_DELAY 2	   // SCL�����غ���ʱ
#define ACK_SAMPLE_RETRY 3	   // ��������    ���Ը���

// 数码管
unsigned char seg_code[] = {0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F}; // 0~9
unsigned char led_place[] = {0x68, 0x6A, 0x6C, 0x6E};


unsigned int Number_Sum = 0;
unsigned int Number_Ge = 0;
unsigned int Number_Shi = 0;
unsigned int Number_Bai = 0;
unsigned int Number_Qian = 0;

// ADC
volatile unsigned int adcData = 0;
volatile unsigned int theVoltage = 0;

// Variable definition
volatile char W_TMP @0x70;	 // �0�3�0�1�0�8�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
volatile char BSR_TMP @0x71; // �0�3�0�1�0�8�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7


void user_isr();
//===========================================================
// Funtion name�1�7�1�7interrupt ISR
// parameters�1�7�1�7�1�7�1�7
// returned value�1�7�1�7�1�7�1�7
//===========================================================
void interrupt ISR(void)
{
#asm;			// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	NOP;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
#endasm;		// �0�3�0�1�1�7�1�7�1�7���1�7�1�7�1�7�1�7�1�7�0�1�1�7�1�7�1�7�1�7�1�7�1�0�1�7
	user_isr(); // �1�7�1�7�1�7�1�7�1�7�0�4�1�7�1�7�؁0�8�1�7�1�7�1�7
}
void user_isr() // �1�7�1�7�1�7�1�7�1�7�0�4�1�7�1�7�؁0�8�1�7�1�7�1�7
{
}

/*-------------------------------------------------
 * 函数名：POWER_INITIAL
 * 功能： 	 上电系统初始化
 * 输入：	 无
 * 输出： 	 无
 --------------------------------------------------*/
void POWER_INITIAL(void)
{
	OSCCON = 0B01100001; // 系统时钟选择为内部振荡器8MHz,分频比为1:1

	PCKEN |= 0B00000001; // AD模块时钟使能

	INTCON = 0; // 禁止所有中断

	PORTA = 0B00000000;
	PORTB = 0B00000000;
	PORTC = 0B00000000;

	WPUA = 0B00000000; // 弱上拉的开关，0-关，1-开
	WPUB = 0B00000000;
	WPUC = 0B00000000;

	WPDA = 0B00000000; // 弱下拉的开关，0-关，1-开
	WPDB = 0B00000000;
	WPDC = 0B00000000;

	TRISA = 0B00000000; // 输入输出设置，0-输出，1-输入
	TRISB = 0B00000010; // PB1输入
	TRISC = 0B00000000;

	PSRC0 = 0B11111111; // 源电流设置最大
	PSRC1 = 0B11111111;
	PSRC2 = 0B00001111;

	PSINK0 = 0B11111111; // 灌电流设置最大
	PSINK1 = 0B11111111;
	PSINK2 = 0B00000011;

	ANSELA = 0B00000000; // 设置对应的IO为数字IO
}

void main(void)
{
	POWER_INITIAL(); // �0�3�0�1�1�7�1�7�0�3�1�7�1�7
	ADC_INITIAL();	 // ADC�1�7�1�7�0�3�1�7�1�7
	TM1650_Init();
	TM1650_Set(led_place[0], seg_code[9]); // 能显示，测试

	while (1)
	{
		DelayMs(500);
		adcData = GET_ADC_DATA(0);
		theVoltage = (unsigned long)adcData * 2 * 1000 / 4096;
		Number_Sum = theVoltage; // 提取4位数
		Number_Ge = Number_Sum / 1000;
		Number_Shi = (Number_Sum / 100) % 10;
		Number_Bai = (Number_Sum / 10) % 10;
		Number_Qian = Number_Sum % 10;

		TM1650_Set(led_place[0], (seg_code[Number_Ge]|0x80));//小数点
		TM1650_Set(led_place[1], seg_code[Number_Shi]);
		TM1650_Set(led_place[2], seg_code[Number_Bai]);
		TM1650_Set(led_place[3], seg_code[Number_Qian]);

		NOP();
		NOP();
	}
}